generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MEMBER
  ADMIN
}

model Community {
  id        String   @id @default(cuid())
  whopId    String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  subscriptions Subscription[]
  league        League?
  members       Member[]
  pointsConfig  PointsConfig?
}

model League {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  communityId String   @unique
  
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  tiers     Tier[]
  
  @@index([communityId])
}

model Tier {
  id               String   @id @default(cuid())
  name             String
  description      String?
  minScore         Int
  order            Int
  color            String?
  icon             String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  leagueId         String
  
  league           League        @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  messages         Message[]
  members          Member[]
  
  @@index([leagueId])
  @@index([leagueId, order])
}

model Member {
  id                String   @id @default(cuid())
  communityId       String
  whopId            String
  name              String?
  role              Role     @default(MEMBER)
  totalScore        Int      @default(0)
  currentTierId     String?
  lastCheckedInDate DateTime?
  checkInStreak     Int      @default(0)
  totalSessionTime  Int      @default(0)
  joinedAt          DateTime @default(now())
  lastActive        DateTime @default(now())
  
  community        Community      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  currentTier      Tier?          @relation(fields: [currentTierId], references: [id])
  messages         Message[]
  scoreHistory     ScoreHistory[]
  messageReads     MessageRead[]
  
  @@unique([communityId, whopId])
  @@index([whopId])
  @@index([communityId, totalScore])
  @@index([currentTierId])
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  tierId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isEdited  Boolean  @default(false)
  isPinned  Boolean  @default(false)
  
  tier          Tier          @relation(fields: [tierId], references: [id], onDelete: Cascade)
  author        Member        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  messageReads  MessageRead[]
  
  @@index([tierId, createdAt])
  @@index([authorId])
}

model MessageRead {
  id            String   @id @default(cuid())
  messageId     String
  memberId      String
  viewedAt      DateTime @default(now())
  pointsAwarded Boolean  @default(false)
  
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, memberId])
  @@index([memberId, viewedAt])
}

model ScoreHistory {
  id          String   @id @default(cuid())
  memberId    String
  points      Int
  reason      String?
  sourceType  String?
  sourceId    String?
  createdAt   DateTime @default(now())
  
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([memberId, createdAt])
}

model Subscription {
  id               String    @id @default(cuid())
  communityId      String
  userId           String
  whopMembershipId String?   @unique
  planId           String
  status           String    @default("active")
  startedAt        DateTime  @default(now())
  cancelledAt      DateTime?
  expiresAt        DateTime?
  amount           Float     @default(15.00)
  currency         String    @default("usd")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  
  @@index([communityId])
  @@index([userId])
  @@index([status])
}

model PointsConfig {
  id                String   @id @default(cuid())
  communityId       String   @unique
  
  dailyCheckIn      Int      @default(10)
  messageRead       Int      @default(2)
  sessionTime5Min   Int      @default(5)
  
  streak7Days       Int      @default(35)
  streak14Days      Int      @default(70)
  streak30Days      Int      @default(150)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  community         Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  
  @@index([communityId])
}